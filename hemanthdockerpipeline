
pipeline {
  agent { label 'buildserver' }

  tools {
    maven 'M3'
    jdk 'java1.8'
  }

  environment {
    IMAGE = 'hemgit/tomcat'                 // available as env.IMAGE in Groovy, $IMAGE in sh
    TAG   = 'v1'                            // or "${env.BUILD_NUMBER}" for unique tags
    REMOTE_HOST = 'devops@172.31.42.212'
    REMOTE_DIR  = '/home/devops/webapp1'
  }

  stages {
    stage('Prepare-Workspace') {
      steps {
        git branch: 'master',
            credentialsId: 'a6d19976-1ac0-4b35-97a9-9620430929b5',
            url: 'https://github.com/Hemgit/Maven-Java-Project.git'
        stash name: 'Source'
      }
    }

    stage('Build') {
      steps {
        sh 'mvn clean compile'
      }
    }

    stage('Unit Test Cases') {
      tools { jdk 'java1.8' }
      steps {
        echo 'Clean and Test'
        sh 'mvn clean test'
      }
      post {
        success {
          echo 'Publishing JUnit'
          junit 'target/surefire-reports/*.xml'
        }
      }
    }

    stage('Build Code') {
      steps {
        unstash 'Source'
        sh 'mvn clean package -DskipTests'
      }
      post {
        success {
          archiveArtifacts '**/*.war'
        }
      }
    }

    stage('Remote Docker Build') {
      steps {
        // NOTE: docker12 MUST be an SSH Username with private key
        sshagent(credentials: ['docker12']) {
          sh '''
            set -e
            # Use env vars exported by pipeline
            ssh -o StrictHostKeyChecking=no "$REMOTE_HOST" "mkdir -p $REMOTE_DIR"

            scp -o StrictHostKeyChecking=no target/*.war "$REMOTE_HOST:$REMOTE_DIR/java-maven-1.0-SNAPSHOT.war"
            ssh -o StrictHostKeyChecking=no "$REMOTE_HOST" "mv -f $REMOTE_DIR/java-maven-1.0-SNAPSHOT.war $REMOTE_DIR/student.war"
            scp -o StrictHostKeyChecking=no Dockerfile "$REMOTE_HOST:$REMOTE_DIR/"

            # Build WITH TAG on remote host
            ssh -o StrictHostKeyChecking=no "$REMOTE_HOST" "cd $REMOTE_DIR && docker build -t $IMAGE:$TAG ."

            # Sanity: show image
            ssh -o StrictHostKeyChecking=no "$REMOTE_HOST" "docker images | grep $IMAGE"
          '''
        }
      }
    }

    stage('Remote Docker Push') {
      steps {
        // dockerhub MUST be Username/Password (Docker Hub)
        withCredentials([usernamePassword(credentialsId: 'dockerhub',
                                         usernameVariable: 'DOCKER_USER',
                                         passwordVariable: 'DOCKER_PASSWORD')]) {
          sshagent(credentials: ['docker12']) {
            sh '''
              set -e
              ssh -o StrictHostKeyChecking=no "$REMOTE_HOST" "echo \\"$DOCKER_PASSWORD\\" | docker login -u \\"$DOCKER_USER\\" --password-stdin"
              ssh -o StrictHostKeyChecking=no "$REMOTE_HOST" "docker push $IMAGE:$TAG"
              ssh -o StrictHostKeyChecking=no "$REMOTE_HOST" "docker logout || true"
            '''
          }
        }
      }
    }

    // Example Deploy stage on the same remote host:
    stage('Deploy') {
      steps {
        sshagent(credentials: ['docker12']) {
          sh '''
            set -e
            APP_NAME=studentapp
            PORT=8080

            # Stop & remove existing container if running
            ssh -o StrictHostKeyChecking=no "$REMOTE_HOST" \
              "docker ps -q --filter name=$APP_NAME | xargs -r docker stop && \
               docker ps -a -q --filter name=$APP_NAME | xargs -r docker rm"

            # If the host didnâ€™t build the image locally or you want to ensure fresh pull:
            ssh -o StrictHostKeyChecking=no "$REMOTE_HOST" "docker pull $IMAGE:$TAG || true"

            # Run new container
            ssh -o StrictHostKeyChecking=no "$REMOTE_HOST" \
              "docker run -d --name $APP_NAME --restart=always -p $PORT:8080 $IMAGE:$TAG"

            # Health check / status
            ssh -o StrictHostKeyChecking=no "$REMOTE_HOST" \
              "sleep 3; docker ps --filter name=$APP_NAME --format '{{.Names}} {{.Status}}'"
          '''
        }
      }
    }
  }
}
