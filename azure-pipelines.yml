
# =========================
# Hemgit Maven → Docker → Deploy (multi-stage)
# =========================

name: $(Build.DefinitionName)_$(Build.SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)

trigger:
- master

pool:
  name: awspool

variables:
  IMAGE: 'hemgit/tomcat'
  TAG: '$(Build.BuildNumber)'
  REMOTE_DIR: '/home/devops/webapp1'
  APP_NAME: 'studentapp'
  PORT: '8080'

stages:

# ---------------------------------------------------------------------------
# 1) BUILD & TEST
# ---------------------------------------------------------------------------
- stage: BuildAndTest
  displayName: 'Build & Test'
  jobs:
  - job: Build
    displayName: 'Maven build, test, package'
    steps:
    - checkout: self

    - task: Maven@3
      displayName: 'mvn clean compile'
      inputs:
        mavenPomFile: 'pom.xml'
        goals: 'clean compile'
        jdkVersionOption: '1.8'

    - task: Maven@3
      displayName: 'mvn test'
      inputs:
        mavenPomFile: 'pom.xml'
        goals: 'test'
        publishJUnitResults: true
        testResultsFiles: 'target/surefire-reports/*.xml'
        jdkVersionOption: '1.8'

    - task: Maven@3
      displayName: 'mvn package -DskipTests'
      inputs:
        mavenPomFile: 'pom.xml'
        goals: 'package -DskipTests'
        jdkVersionOption: '1.8'

    - task: CopyFiles@2
      inputs:
        contents: 'target/*.war'
        targetFolder: '$(Build.ArtifactStagingDirectory)'

    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)'
        artifact: 'war'

# ---------------------------------------------------------------------------
# 2) REMOTE DOCKER BUILD
# ---------------------------------------------------------------------------
- stage: RemoteBuild
  displayName: 'Remote Docker Build'
  dependsOn: BuildAndTest
  condition: succeeded()
  jobs:
  - job: RemoteDockerBuild
    steps:

    - checkout: self

    - task: DownloadPipelineArtifact@2
      inputs:
        artifact: 'war'
        path: '$(Pipeline.Workspace)/war'

    - script: |
        echo "Artifacts after download:"
        ls -lR "$(Pipeline.Workspace)/war"
      displayName: 'Sanity check artifacts'

    - task: SSH@0
      displayName: 'Prepare remote directory'
      inputs:
        sshEndpoint: 'ssh-docker-host'
        runOptions: 'commands'
        commands: |
          mkdir -p "$(REMOTE_DIR)/target"

    # Copy Dockerfile
    - task: CopyFilesOverSSH@0
      displayName: 'Copy Dockerfile'
      inputs:
        sshEndpoint: 'ssh-docker-host'
        sourceFolder: '$(Build.SourcesDirectory)'
        contents: 'Dockerfile'
        targetFolder: '$(REMOTE_DIR)'

    # Copy WAR file into /target
    - task: CopyFilesOverSSH@0
      displayName: 'Copy WAR to remote target folder'
      inputs:
        sshEndpoint: 'ssh-docker-host'
        sourceFolder: '$(Pipeline.Workspace)/war'
        contents: '**/*.war'
        targetFolder: '$(REMOTE_DIR)/target'

    # Rename + docker build
    - task: SSH@0
      displayName: 'Rename WAR and build image'
      inputs:
        sshEndpoint: 'ssh-docker-host'
        runOptions: 'commands'
        commands: |
          set -e
          echo "Checking remote folders..."
          ls -l "$(REMOTE_DIR)"
          ls -l "$(REMOTE_DIR)/target"

          WAR_FILE=$(find "$(REMOTE_DIR)/target" -maxdepth 1 -type f -name '*.war' -print -quit)
          if [ -z "$WAR_FILE" ]; then
            echo "WAR not found!"
            exit 1
          fi

          # Remove wrong directory if present
          if [ -d "$(REMOTE_DIR)/student.war" ]; then
            rm -rf "$(REMOTE_DIR)/student.war"
          fi

          mv -f "$WAR_FILE" "$(REMOTE_DIR)/student.war"

          cd "$(REMOTE_DIR)"
          docker build -t "$(IMAGE):$(TAG)" -f Dockerfile .

          echo "Docker images:"
          docker images | grep "$(IMAGE)"

# ---------------------------------------------------------------------------
# 3) REMOTE DOCKER PUSH
# ---------------------------------------------------------------------------
- stage: RemotePush
  dependsOn: RemoteBuild
  jobs:
  - job: DockerPush
    steps:
    - task: SSH@0
      displayName: 'Push to Docker Hub'
      inputs:
        sshEndpoint: 'ssh-docker-host'
        runOptions: 'commands'
        commands: |
          echo "$(dockerhub.password)" | docker login -u "$(dockerhub.user)" --password-stdin
          docker push "$(IMAGE):$(TAG)"
          docker logout || true

# ---------------------------------------------------------------------------
# 4) DEPLOY
# ---------------------------------------------------------------------------
- stage: Deploy
  dependsOn: RemotePush
  jobs:
  - job: RemoteDeploy
    steps:
    - task: SSH@0
      displayName: 'Deploy container'
      inputs:
        sshEndpoint: 'ssh-docker-host'
        runOptions: 'commands'
        commands: |
          docker ps -q --filter "name=$(APP_NAME)" | xargs -r docker stop
          docker ps -a -q --filter "name=$(APP_NAME)" | xargs -r docker rm
          
          docker pull "$(IMAGE):$(TAG)" || true
          
          docker run -d --name "$(APP_NAME)" --restart=always -p "$(PORT):8080" "$(IMAGE):$(TAG)"
          docker ps | grep "$(APP_NAME)"
